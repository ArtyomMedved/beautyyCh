<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Мастер маникюра - beautyyCh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Montserrat", sans-serif;
        background-color: #fff1f3;
        color: #831843;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        box-sizing: border-box;
      }
      header {
        border-bottom: 1px solid #f9a8d4;
        background-color: #ffe4ec;
      }
      header .header-container {
        max-width: 1120px;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 60px;
        flex-wrap: wrap;
      }
      header .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        font-size: 1.5rem;
        color: #831843;
        user-select: none;
        text-decoration: none;
        flex-shrink: 0;
      }
      header .logo img {
        height: 40px;
        width: auto;
      }
      nav.main-nav {
        display: flex;
        gap: 1.5rem;
        flex-wrap: nowrap;
        white-space: nowrap;
        flex-shrink: 0;
      }
      nav.main-nav a {
        color: #831843;
        font-weight: 600;
        font-size: 0.875rem;
        text-decoration: none;
        transition: color 0.3s;
      }
      nav.main-nav a:hover {
        color: #9d174d;
      }
      main {
        max-width: 1120px;
        margin: 2rem auto 4rem;
        padding: 0 1rem;
        box-sizing: border-box;
      }
      h1 {
        font-weight: 800;
        font-size: 3rem;
        margin-bottom: 0.5rem;
        color: #831843;
        text-shadow: 1px 1px 4px rgba(157, 23, 77, 0.5);
      }
      .course-subtitle {
        font-size: 1.25rem;
        color: #9d174d;
        margin-bottom: 1.5rem;
        max-width: 720px;
        line-height: 1.6;
      }
      .content-wrapper {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }
      @media (min-width: 1024px) {
        .content-wrapper {
          flex-direction: row;
        }
      }
      .left-column {
        flex: 2;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }
      .video-wrapper {
        position: relative;
        padding-top: 56.25%;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 6px 15px rgba(157, 23, 77, 0.3);
        background-color: black;
      }
      .video-wrapper iframe,
      .video-wrapper video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0.75rem;
      }
      .gallery {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
      .gallery img {
        width: 100%;
        border-radius: 0.75rem;
        object-fit: cover;
        height: 160px;
        box-shadow: 0 4px 12px rgba(157, 23, 77, 0.2);
        transition: transform 0.3s ease;
        cursor: pointer;
      }
      .gallery img:hover {
        transform: scale(1.05);
      }
      .right-column {
        flex: 1;
        background-color: #fff0f6;
        border: 1px solid #f9a8d4;
        border-radius: 0.75rem;
        padding: 1.5rem 1.5rem 1rem 1.5rem;
        box-sizing: border-box;
        box-shadow: 0 6px 15px rgba(157, 23, 77, 0.15);
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        max-width: 320px;
        margin: 0 auto;
      }
      .price {
        font-size: 2rem;
        font-weight: 700;
        color: #f43f5e;
        margin-bottom: 1rem;
        text-align: center;
        text-shadow: 1px 1px 3px rgba(244, 63, 94, 0.6);
      }
      .btn-purchase {
        background-color: #9d174d;
        color: white;
        font-weight: 700;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-size: 1.25rem;
        width: 100%;
        transition: background-color 0.3s, box-shadow 0.3s;
        box-shadow: 0 4px 10px rgba(157, 23, 77, 0.4);
        margin-bottom: 1rem;
      }
      .btn-purchase:hover {
        background-color: #be185d;
        box-shadow: 0 6px 15px rgba(190, 24, 93, 0.6);
      }
      .course-details {
        font-size: 1.125rem;
        color: #9d174d;
        line-height: 1.6;
        border-top: 1px solid #f9a8d4;
        padding-top: 1rem;
      }
      .section-title {
        font-weight: 700;
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: #831843;
        border-bottom: 2px solid #9d174d;
        padding-bottom: 0.25rem;
        max-width: max-content;
      }
      .features-list {
        list-style: none;
        padding-left: 0;
        margin-top: 0.5rem;
      }
      .features-list li {
        margin-bottom: 0.5rem;
        padding-left: 1.5rem;
        position: relative;
        color: #9d174d;
      }
      .features-list li::before {
        content: "\f00c";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        left: 0;
        top: 0;
        color: #f43f5e;
        font-size: 1rem;
        line-height: 1;
      }
      .support-info {
        font-size: 0.9rem;
        color: #831843;
        background-color: #fce7f3;
        border: 1px solid #f9a8d4;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        box-shadow: 0 2px 8px rgba(157, 23, 77, 0.1);
        margin-top: auto;
        text-align: center;
        line-height: 1.3;
      }
      .support-info a {
        color: #9d174d;
        font-weight: 700;
        text-decoration: none;
        transition: text-decoration 0.3s;
      }
      .support-info a:hover {
        text-decoration: underline;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        display: none; /* по умолчанию скрыто */
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal {
        background: white;
        border-radius: 0.75rem;
        width: 350px;
        height: 350px;
        padding: 1.5rem;
        box-shadow: 0 6px 15px rgba(157, 23, 77, 0.3);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
      }
      .modal h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: #831843;
        border-bottom: 2px solid #9d174d;
        padding-bottom: 0.25rem;
      }
      .modal .info-item {
        margin-bottom: 0.75rem;
        font-size: 1rem;
        color: #9d174d;
      }
      .modal .info-label {
        font-weight: 600;
        color: #831843;
      }
      .modal .qr-code-placeholder {
        flex-grow: 1;
        border: 2px dashed #f43f5e;
        border-radius: 0.5rem;
        margin-top: 0.75rem;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #f43f5e;
        font-weight: 600;
        font-size: 0.9rem;
      }
      .modal .close-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: transparent;
        border: none;
        font-size: 1.5rem;
        color: #9d174d;
        cursor: pointer;
        transition: color 0.3s;
      }
      .modal .close-btn:hover {
        color: #f43f5e;
      }
      @keyframes fade-in-up {
        0% {
          opacity: 0;
          transform: translateY(20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in-up {
        animation: fade-in-up 0.3s ease-out both;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-container">
        <a class="logo" href="/">
          <img
            alt="Логотип школы beautyyCh"
            class="h-10 w-auto"
            height="40"
            src="https://i.yapx.ru/ZGgcn.png"
            width="120"
          />
          beautyyCh
        </a>
        <nav aria-label="Основное меню" class="main-nav">
          <a href="./about_school">О школе</a>
          <a href="./Training_list">Обучение</a>
          <a href="./profile"> Профиль </a>
        </nav>
      </div>
    </header>
    <main>
      <h1>{{title}}</h1>
      <p>{{description}}</p>
      <div class="content-wrapper">
        <div class="left-column">
          <section
            aria-label="Демонстрационное видео курса"
            class="video-wrapper"
          >
            <video
              class="w-full h-full rounded-xl shadow"
              controls
              src="{{demo_video}}"
            >
              Ваш браузер не поддерживает видео.
            </video>
          </section>

          <section aria-label="Галерея работ" class="gallery" tabindex="0">
            {{images}}
          </section>
          <section class="course-details" aria-label="Подробности курса">
            <h2 class="text-2xl font-bold mt-8 mb-2">Что вы получите</h2>
            <p class="mb-6">{{features}}</p>
          </section>
        </div>
        <aside class="right-column" aria-label="Информация о покупке курса">
          <p class="price">Цена: {{price}}₽</p>
          <button
            id="btnPurchase"
            class="btn-purchase"
            type="button"
            data-course-id="{{courseId}}"
            data-course-title="{{title}}"
            data-price="{{price}}"
          >
            Приобрести
          </button>

          <div class="support-info" role="region" aria-label="Онлайн поддержка">
            <p>
              Есть вопросы?
              <a
                href="mailto:support@beautyych.ru"
                target="_blank"
                rel="noopener noreferrer"
                >Свяжитесь с нашей онлайн поддержкой</a
              >
            </p>
          </div>
        </aside>
      </div>
    </main>

    <!-- Модальное окно оплаты -->
    <div
      id="paymentModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalTitle"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-xl p-8 flex flex-col animate-fade-in-up"
        role="document"
      >
        <h2
          id="modalTitle"
          class="text-2xl font-bold text-pink-700 mb-4 text-center border-b-2 border-pink-500 pb-2"
        >
          Информация для оплаты
        </h2>
        <div class="flex-1 space-y-3 text-pink-800">
          <p><strong>Телефон для связи:</strong> +7 999 123-45-67</p>
          <p>
            <strong>Банк для перевода:</strong> Сбербанк 1234 5678 9012 3456
          </p>
          <p>
            <strong>Сумма к оплате:</strong> <span id="paymentAmount"></span>₽
          </p>
          <p>
            <strong>Комментарий при переводе:</strong>
            <span id="paymentComment" class="break-all"></span>
          </p>
          <div
            id="qrCodePlaceholder"
            class="w-full h-32 border-2 border-dashed border-pink-300 rounded flex items-center justify-center text-pink-400 font-semibold"
          >
            QR-код для оплаты (здесь будет)
          </div>
        </div>

        <div class="mt-6 flex justify-end gap-3">
          <button
            id="btnConfirmPayment"
            class="bg-pink-700 text-white rounded px-5 py-2 font-semibold hover:bg-pink-800 transition"
            type="button"
          >
            Я оплатил/а
          </button>
          <button
            id="btnCloseModal"
            class="bg-gray-200 text-gray-800 rounded px-5 py-2 font-semibold hover:bg-gray-300 transition"
            type="button"
          >
            Закрыть
          </button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const btnPurchase = document.getElementById("btnPurchase");
        const modal = document.getElementById("paymentModal");
        const paymentCommentElem = document.getElementById("paymentComment");
        const paymentAmountElem = document.getElementById("paymentAmount");
        const btnConfirmPayment = document.getElementById("btnConfirmPayment");
        const btnCloseModal = document.getElementById("btnCloseModal");

        let paymentCommentCode = null;

        function generatePaymentComment(title) {
          if (paymentCommentCode === null) {
            paymentCommentCode = Math.floor(1000 + Math.random() * 9000);
          }
          return `За курс ${title} №${paymentCommentCode}`;
        }

        // Предварительная проверка перед показом модалки
        btnPurchase.addEventListener("click", async () => {
          const courseId = btnPurchase.dataset.courseId;
          const courseTitle = btnPurchase.dataset.courseTitle;
          const price = btnPurchase.dataset.price || "";

          const comment = generatePaymentComment(courseTitle);

          try {
            const profileResponse = await fetch("/api/profile");
            if (!profileResponse.ok)
              throw new Error("Не удалось получить профиль");
            const profile = await profileResponse.json();

            const checkResponse = await fetch("/api/payments/check", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                user_id: profile.id,
                course_id: courseId,
                payment_comment: comment,
              }),
            });

            const checkData = await checkResponse.json();
            if (checkData.exists) {
              alert("Вы уже оставили заявку на этот курс. Ожидайте обработки.");
              return;
            }

            // Если не найдено — показываем модалку
            paymentCommentElem.textContent = comment;
            paymentAmountElem.textContent = price;
            modal.classList.remove("hidden");
          } catch (err) {
            alert("Ошибка при проверке оплаты: " + err.message);
          }
        });

        btnCloseModal.addEventListener("click", () => {
          modal.classList.add("hidden");
        });

        btnConfirmPayment.addEventListener("click", async () => {
          const courseId = btnPurchase.dataset.courseId;
          const courseTitle = btnPurchase.dataset.courseTitle;
          const paymentComment = paymentCommentElem.textContent;

          try {
            const profileResponse = await fetch("/api/profile");
            if (!profileResponse.ok)
              throw new Error("Не удалось получить профиль");
            const profile = await profileResponse.json();

            const checkResponse = await fetch("/api/payments/check", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                user_id: profile.id,
                course_id: courseId,
                payment_comment: paymentComment,
              }),
            });

            const checkData = await checkResponse.json();
            if (checkData.exists) {
              alert(
                "Вы уже оставили заявку на этот курс с этим комментарием. Пожалуйста, дождитесь обработки."
              );
              return;
            }

            const saveResponse = await fetch("/api/payments", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                user_id: profile.id,
                user_name: profile.name,
                course_id: courseId,
                course_title: courseTitle,
                payment_comment: paymentComment,
              }),
            });

            if (!saveResponse.ok)
              throw new Error("Ошибка при сохранении заявки");

            alert("Заявка успешно сохранена. Спасибо!");
            modal.classList.add("hidden");
          } catch (err) {
            alert(err.message);
          }
        });
      })();
    </script>
  </body>
</html>
